"use strict";angular.module("angular-ui-vote-tally",[]).service("VoteTally",function(){return{methods:[{id:"simpleMajority",title:"Simple Majority",description:"50% + 1 wins"},{id:"2/3rds",title:"Two-thirds majority",description:"FIXME"},{id:"3/5ths",title:"Three-fifths majority",description:"FIXME"},{id:"unsc",title:"UN Security Council (9/14ths)",description:"Abstentions do not count during calculation"},{id:"unanimous",title:"Unanimous",description:"All votes must be in favour, none must reject to pass"}],getWinLose:function(options){var realTotal=options.total-(options.abstain||0);switch(options.method){case"2/3rds":if(0==realTotal)return{toWin:0,toLose:0,voters:0};if(1==realTotal)return{toWin:1,toLose:1,voters:1};if(2==realTotal)return{toWin:2,toLose:1,voters:2};var third=Math.floor(realTotal/3);return{toWin:2*third,toLose:1*third+1,voters:realTotal};case"3/5ths":if(0==realTotal)return{toWin:0,toLose:0,voters:0};if(1==realTotal)return{toWin:1,toLose:1,voters:1};if(2==realTotal)return{toWin:2,toLose:1,voters:2};if(3==realTotal)return{toWin:3,toLose:1,voters:3};if(4==realTotal)return{toWin:3,toLose:2,voters:4};var fifth=Math.ceil(realTotal/5);return{toWin:3*fifth+1,toLose:2*fifth,voters:realTotal};case"unsc":realTotal=options.total;var segment=Math.ceil(realTotal/14);return{toWin:9*segment,toLose:5*segment,voters:realTotal};case"unanimous":return 0==realTotal?{toWin:0,toLose:0,voters:0}:{toWin:realTotal,toLose:1,voters:realTotal};case"simpleMajority":return 0==realTotal?{toWin:0,toLose:0,voters:0}:1==realTotal?{toWin:1,toLose:1,voters:1}:{toWin:Math.ceil(realTotal/2)+1,toLose:Math.ceil(realTotal/2),voters:realTotal};default:throw new Error("Unknown vote method: "+options.method)}}}}).component("voteTally",{bindings:{total:"<",approve:"<",reject:"<",abstain:"<",summary:"<",method:"@",tooltips:"<"},controller:["$scope","VoteTally",function($scope,VoteTally){var $ctrl=this;$ctrl.settings={approve:{class:"progress-bar progress-bar-success",summaryClass:"alert alert-success",width:0,target:0},reject:{class:"progress-bar progress-bar-danger pull-right",summaryClass:"alert alert-danger",width:0,target:0},abstain:{class:"progress-bar progress-bar-default pull-right",summaryClass:"alert alert-default",width:0},waiting:{summaryClass:"alert alert-info",width:0,count:0},target:{width:0}},$scope.winner,$scope.$watchGroup(["$ctrl.method","$ctrl.approve","$ctrl.reject","$ctrl.abstain"],function(){var ratio=VoteTally.getWinLose({method:$ctrl.method||"50/50",total:$ctrl.total,abstain:$ctrl.abstain});$ctrl.settings.approve.target=ratio.toWin,$ctrl.settings.reject.target=ratio.toLose,$ctrl.settings.target.width=ratio.toWin/$ctrl.total*100,$scope.winner=$ctrl.approve>=ratio.toWin?"approve":$ctrl.reject>=ratio.toLose?"reject":null}),$scope.$watchGroup(["$ctrl.total","$ctrl.approve"],function(){return $ctrl.settings.approve.width=$ctrl.approve/$ctrl.total*100}),$scope.$watchGroup(["$ctrl.total","$ctrl.reject"],function(){return $ctrl.settings.reject.width=$ctrl.reject/$ctrl.total*100}),$scope.$watchGroup(["$ctrl.total","$ctrl.abstain"],function(){return $ctrl.settings.abstain.width=$ctrl.abstain/$ctrl.total*100}),$scope.$watchGroup(["$ctrl.total","$ctrl.approve","$ctrl.reject","$ctrl.abstain"],function(){$ctrl.settings.waiting.count=$ctrl.total-$ctrl.approve-$ctrl.reject-$ctrl.abstain,$ctrl.settings.waiting.width=$ctrl.settings.waiting.count/$ctrl.total*100})}],template:'\n\t\t\t<div class="vote-tally" ng-class="{\'vote-tally-winner-approve\': winner == \'approve\', \'vote-tally-winner-reject\': winner == \'reject\'}">\n\t\t\t\t<div class="progress">\n\t\t\t\t\t<div ng-class="$ctrl.settings.approve.class" style="width: {{$ctrl.settings.approve.width}}%" tooltip="{{$ctrl.approve}} in favour" tooltip-show="$ctrl.tooltips==\'always\' ? true : $ctrl.tooltips==\'never\' ? false : null" tooltip-position="bottom" tooltip-tether="100"></div>\n\t\t\t\t\t<div ng-class="$ctrl.settings.abstain.class" style="width: {{$ctrl.settings.abstain.width}}%" tooltip="{{$ctrl.abstain}} abstain" tooltip-show="$ctrl.tooltips==\'always\' ? true : $ctrl.tooltips==\'never\' ? false : null" tooltip-position="bottom" tooltip-tether="100"></div>\n\t\t\t\t\t<div ng-class="$ctrl.settings.reject.class" style="width: {{$ctrl.settings.reject.width}}%" tooltip="{{$ctrl.reject}} reject" tooltip-show="$ctrl.tooltips==\'always\' ? true : $ctrl.tooltips==\'never\' ? false : null" tooltip-position="bottom" tooltip-tether="100"></div>\n\t\t\t\t\t<div class="vote-tally-target" style="width: {{$ctrl.settings.target.width}}%">\n\t\t\t\t\t\t<div class="vote-tally-target-arrow-down"></div>\n\t\t\t\t\t\t<div class="vote-tally-target-arrow-up"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div ng-if="$ctrl.summary" class="container row">\n\t\t\t\t\t<div class="col-xs-3 text-center">\n\t\t\t\t\t\t<div ng-class="$ctrl.settings.approve.summaryClass">{{$ctrl.approve}} / {{$ctrl.settings.approve.target}} to pass</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="col-xs-3 text-center">\n\t\t\t\t\t\t<div ng-class="$ctrl.settings.reject.summaryClass">{{$ctrl.reject}} / {{$ctrl.settings.reject.target}} to reject</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="col-xs-3 text-center">\n\t\t\t\t\t\t<div ng-class="$ctrl.settings.waiting.summaryClass">{{$ctrl.settings.waiting.count}} to vote</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="col-xs-3 text-center">\n\t\t\t\t\t\t<div ng-class="$ctrl.settings.abstain.summaryClass">{{$ctrl.abstain}} abstaining</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'});